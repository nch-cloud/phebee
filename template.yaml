AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: PheBee
Globals:
  Function:
    Timeout: 90
    Architectures:
      - arm64
    Tracing: Active
    Runtime: python3.11
    Environment:
      Variables:
        POWERTOOLS_SERVICE_NAME: phebee

Parameters:
  AppName:
    Type: String
    Description: "Application name used for resource naming (e.g., phebee-dev-2)"
    Default: phebee
    AllowedPattern: "^[a-z0-9-]+$"
    ConstraintDescription: "Must contain only lowercase letters, numbers, and hyphens"

  VpcId:
    Default: false
    Description: "VPC in which Neptune is supposed to run. ex: vpc-xxxxxxxxxxxxxx"
    Type: String  

  SubnetId1:
    Default: false
    Description: "Subnet in the VPC which Neptune is supposed to run. ex: subnet-xxxxxxxxxxxxxx"
    Type: String  

  SubnetId2:
    Default: false
    Description: "Subnet in the VPC which Neptune is supposed to run. ex: subnet-xxxxxxxxxxxxxx"
    Type: String   

  CreateS3Bucket:
    Default: true
    AllowedValues:
      - true
      - false
    Description: Create a new S3 bucket to hold PheBee data
    Type: String

  S3AccessLogBucketName:
    Type: String
    Description: Optional. An existing bucket where access logs should be delivered.
    Default: ""
  
  S3AccessLogPrefix:
    Type: String
    Description: Optional. Prefix (folder path) for the logs in the log bucket.
    Default: phebee-access-logs/

  RunOntologyUpdatesOnSchedule:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]
    Description: Whether to enable scheduled ontology updates

  IcebergDatabase:
    Type: String
    Default: "phebee"
    Description: "Glue database name for Iceberg tables"
  
  IcebergEvidenceTable:
    Type: String
    Default: "evidence"
    Description: "Iceberg table name for evidence storage"
  
  CreateEvidenceTableFlag:
    Type: String
    Default: "true"
    AllowedValues: ["true", "false"]
    Description: "Whether to create the Glue database and Iceberg table for evidence storage"

  HPOScheduleExpression:
    Type: String
    Default: "cron(0 9 * * ? *)"  # 4 AM EST = 9 UTC
    Description: Cron expression for HPO update

  MondoScheduleExpression:
    Type: String
    Default: "cron(10 9 * * ? *)"  # 4:10 AM EST = 9:10 UTC
    Description: Cron expression for Mondo update

  ECOScheduleExpression:
    Type: String
    Default: "cron(20 9 * * ? *)"  # 4:20 AM EST = 9:20 UTC
    Description: Cron expression for ECO update

Conditions:
  ShouldCreateS3Bucket: !Equals [!Ref CreateS3Bucket, true]

  ShouldEnableS3Logging: !Not [!Equals [!Ref S3AccessLogBucketName, ""]]

  EnableScheduledOntologyUpdate: !Equals [!Ref RunOntologyUpdatesOnSchedule, "true"]

  ShouldCreateEvidenceTable: !Equals [!Ref CreateEvidenceTableFlag, "true"]

Resources:
  PheBeeUtilsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub ${AppName}-phebee-utils
      ContentUri: layers/phebee-utils/
      CompatibleRuntimes:
        - python3.11
    Metadata:
      BuildMethod: python3.11

  SAMLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/step_functions/phebee-${AppName}

  #################
  # IAM
  #################

  PheBeeStepFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogDelivery
              - logs:CreateLogStream
              - logs:GetLogDelivery
              - logs:UpdateLogDelivery
              - logs:DeleteLogDelivery
              - logs:ListLogDeliveries
              - logs:PutLogEvents
              - logs:PutResourcePolicy
              - logs:DescribeResourcePolicies
              - logs:DescribeLogGroups
            Resource: "*"
          - Effect: Allow
            Action:
              - events:PutTargets
              - events:PutRule
              - events:DescribeRule
              - events:PutEvents
            Resource: !GetAtt PheBeeBus.Arn
          - Effect: Allow
            Action:
              - events:PutRule
              - events:PutTargets
              - events:DescribeRule
            Resource: !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/StepFunctionsGetEventsForStepFunctionsExecutionRule

  PheBeeAPIRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
        - !Ref PheBeeAPIPolicy

  PheBeeAPIPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt GetSourceInfoFunction.Arn
              - !GetAtt CreateProjectFunction.Arn
              - !GetAtt CreateSubjectFunction.Arn
              - !GetAtt GetSubjectFunction.Arn
              - !GetAtt GetSubjectTermInfoFunction.Arn
              - !GetAtt GetSubjectsPhenotypesFunction.Arn
              - !GetAtt RemoveSubjectFunction.Arn
              - !GetAtt RemoveProjectFunction.Arn
              - !GetAtt CreateEvidenceFunction.Arn
              - !GetAtt GetEvidenceFunction.Arn
              - !GetAtt RemoveEvidenceFunction.Arn
              - !GetAtt CreateTermLinkFunction.Arn
              - !GetAtt GetTermLinkFunction.Arn
              - !GetAtt RemoveTermLinkFunction.Arn
              - !GetAtt QueryProvenanceFunction.Arn
          - Effect: Allow
            Action:
              - states:StartSyncExecution
            Resource:
              - !GetAtt ImportPhenopacketsSFN.Arn

  PheBeeS3ReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:ListBucket
              - s3:PutObject
            Resource:
              - !GetAtt PheBeeBucket.Arn
              - !Sub
                - ${Arn}/*
                - Arn: !GetAtt PheBeeBucket.Arn
  
  PheBeeS3WritePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:PutObject
            Resource:
              - !Sub
                - ${Arn}/*
                - Arn: !GetAtt PheBeeBucket.Arn
  
  PheBeeDynamoDBReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:Scan
              - dynamodb:Query
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:TransactGetItems
            Resource:
              - !GetAtt DynamoDBTable.Arn
  
  PheBeeDynamoDBWritePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:BatchWriteItem
              - dynamodb:TransactWriteItems
              - dynamodb:ConditionCheckItem
            Resource:
              - !GetAtt DynamoDBTable.Arn

  PheBeeNeptuneReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:ReadDataViaQuery
              - neptune-db:GetEngineStatus
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId
          - Effect: Allow
            Action:
              - rds:DescribeDBClusters
            Resource: !Sub arn:${AWS::Partition}:rds:${AWS::Region}:${AWS::AccountId}:cluster:${AppName}-neptune-cluster
  
  PheBeeNeptuneLoadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:StartLoaderJob
              - neptune-db:GetLoaderJobStatus
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId

  PheBeeNeptuneWritePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:WriteDataViaQuery
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId

  PheBeeNeptuneDeletePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:DeleteDataViaQuery
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId




  PheBeeNeptuneResetPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:ResetDatabase
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId

  PheBeePutEventsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - events:PutEvents
            Resource:
              - !Sub arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:event-bus/${PheBeeBus}

  PheBeeIcebergPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - glue:CreateDatabase
              - glue:GetDatabase
              - glue:CreateTable
              - glue:GetTable
              - glue:UpdateTable
              - glue:DeleteTable
              - glue:GetPartitions
              - athena:StartQueryExecution
              - athena:GetQueryExecution
              - athena:GetQueryResults
              - athena:StopQueryExecution
              - athena:GetWorkGroup
            Resource: "*"
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
              - s3:GetBucketLocation
            Resource:
              - !Sub "${PheBeeBucket.Arn}/iceberg/*"
              - !Sub "${PheBeeBucket.Arn}/athena-results/*"
              - !GetAtt PheBeeBucket.Arn

  CreateEvidenceTableRole:
    Type: AWS::IAM::Role
    Condition: ShouldCreateEvidenceTable
    Properties:
      RoleName: !Sub "${AppName}-CreateEvidenceTableRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - !Ref PheBeeIcebergPolicy

  NeptuneLoaderRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub phebee-neptune-loader-role-${AppName}
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service: rds.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref PheBeeS3ReadPolicy

  UpdateOntologyInvokeRole:
    Type: AWS::IAM::Role
    Condition: EnableScheduledOntologyUpdate
    Properties:
      RoleName: !Sub PheBeeInvokeOntologyUpdatersRole-${AppName}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: "AllowEventBridgeToStartUpdaters"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: "states:StartExecution"
                Resource:
                  - !GetAtt UpdateHPOSFN.Arn
                  - !GetAtt UpdateMondoSFN.Arn
                  - !GetAtt UpdateECOSFN.Arn

  #################
  # Neptune Cluster
  #################
  PheBeeNeptuneSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Amazon Neptune Created
      GroupName: !Sub phebee-neptune-sg-${AppName}
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref PheBeeLambdaSecurityGroup
          IpProtocol: tcp
          FromPort: 8182
          ToPort: 8182
          Description: PheBee Neptune

  PheBeeNeptuneSubnetGroup:
    Type: AWS::Neptune::DBSubnetGroup
    Properties:
      SubnetIds:
      - !Ref SubnetId1
      - !Ref SubnetId2
      DBSubnetGroupDescription: Subnet group for PheBee subnets
      DBSubnetGroupName: !Sub phebee-neptune-subnets-${AppName}

  PheBeeNeptuneCluster:
    Type: AWS::Neptune::DBCluster
    Properties:
      DBClusterIdentifier: !Sub ${AppName}-neptune-cluster
      StorageEncrypted: true
      # Associating the role here is necessary to pass it as the role to use for our bulk loader
      AssociatedRoles:
        - RoleArn: !GetAtt NeptuneLoaderRole.Arn
      ServerlessScalingConfiguration:
        MinCapacity: 1
        MaxCapacity: 16
      PreferredMaintenanceWindow: mon:09:10-mon:09:40
      IamAuthEnabled: true
      DBSubnetGroupName: !Ref PheBeeNeptuneSubnetGroup
      PreferredBackupWindow: 03:59-04:29
      DBPort: 8182
      VpcSecurityGroupIds:
        - !Ref PheBeeNeptuneSecurityGroup
      CopyTagsToSnapshot: true
      DBClusterParameterGroupName: default.neptune1.4
      BackupRetentionPeriod: 7
      EnableCloudwatchLogsExports:
      - audit
      - slowquery

  PheBeeNeptuneInstance:
    Type: AWS::Neptune::DBInstance
    Properties:
      DBInstanceClass: db.r5.large
      DBClusterIdentifier: !Ref PheBeeNeptuneCluster
      DBSubnetGroupName: !Ref PheBeeNeptuneSubnetGroup
      DBParameterGroupName: default.neptune1.4
      AutoMinorVersionUpgrade: true

  #################
  # Lambdas
  #################

  PheBeeLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Amazon Neptune Created
      GroupName: !Sub phebee-lambda-sg-${AppName}
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        # Egress is needed to allow test suite to invoke lambdas and receive a response
        # TODO : Might be able to lock this down to specific ports to further tighten security
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  DownloadGithubReleaseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-DownloadGithubReleaseFunction
      CodeUri: functions
      Handler: download_github_release.lambda_handler
      MemorySize: 1024
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          PheBeeBucketName: !Ref PheBeeBucket
          PheBeeDynamoTable: !Ref DynamoDBTable
      Policies:
        - !Ref PheBeeDynamoDBWritePolicy
        - !Ref PheBeeDynamoDBReadPolicy
        - !Ref PheBeeS3WritePolicy
        - Statement:
          - Effect: Allow
            Action: states:StartExecution
            Resource:
              - !Sub arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:InstallRDFXMLSFN


  UpdateInstallTimestampFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-UpdateInstallTimestampFunction
      CodeUri: functions
      Handler: update_install_timestamp.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          PheBeeDynamoTable: !Ref DynamoDBTable
      Policies:
        - !Ref PheBeeDynamoDBReadPolicy
        - !Ref PheBeeDynamoDBWritePolicy

  StartLoadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-StartLoadFunction
      CodeUri: functions
      Handler: start_load.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneLoadPolicy

  GetLoadStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetLoadStatusFunction
      CodeUri: functions
      Handler: get_load_status.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneLoadPolicy

  GetSourceInfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetSourceInfoFunction
      CodeUri: functions
      Handler: get_source_info.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          PheBeeDynamoTable: !Ref DynamoDBTable
      Policies:
        - !Ref PheBeeDynamoDBReadPolicy

  GetSubjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetSubjectFunction
      CodeUri: functions
      Handler: get_subject.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeDynamoTable: !Ref DynamoDBTable
          PHEBEE_BUCKET_NAME: !Ref PheBeeBucket
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeDynamoDBReadPolicy
        - !Ref PheBeeIcebergPolicy

  GetSubjectTermInfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetSubjectTermInfoFunction
      CodeUri: functions
      Handler: get_subject_term_info.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          ICEBERG_DATABASE: !Ref IcebergDatabase
          ICEBERG_EVIDENCE_TABLE: !Ref IcebergEvidenceTable
          PHEBEE_BUCKET_NAME: !Ref PheBeeBucket
          Region: !Sub ${AWS::Region}
      Policies:
        - !Ref PheBeeIcebergPolicy

  CreateSubjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateSubjectFunction
      CodeUri: functions
      Handler: create_subject.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeBus: !Ref PheBeeBus
          PheBeeDynamoTable: !Ref DynamoDBTable
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy
        - !Ref PheBeePutEventsPolicy
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable

  RemoveSubjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveSubjectFunction
      CodeUri: functions
      Handler: remove_subject.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  CreateProjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateProjectFunction
      CodeUri: functions
      Handler: create_project.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy

  RemoveProjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveProjectFunction
      CodeUri: functions
      Handler: remove_project.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  ParsePhenopacketCollectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ParsePhenopacketCollectionFunction
      CodeUri: functions
      Handler: parse_phenopacket_collection.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          PheBeeBucketName: !Ref PheBeeBucket
      Policies:
        - !Ref PheBeeS3ReadPolicy
        - !Ref PheBeeS3WritePolicy

  ProcessPhenopacketFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ProcessPhenopacketFunction
      CodeUri: functions
      Handler: process_phenopacket.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          PheBeeBucketName: !Ref PheBeeBucket
      Policies:
        - !Ref PheBeeS3ReadPolicy
        - !Ref PheBeeS3WritePolicy
        - !Ref PheBeeNeptuneWritePolicy
        - !Ref PheBeeDynamoDBWritePolicy

  QueryProvenanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-QueryProvenanceFunction
      CodeUri: functions/
      Handler: query_provenance.lambda_handler
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeNeptuneSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy

  GetSubjectsPhenotypesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetSubjectsPhenotypesFunction
      CodeUri: functions
      Handler: get_subjects_pheno.lambda_handler
      MemorySize: 2048
      Timeout: 300
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeBus: !Ref PheBeeBus
          PheBeeBucketName: !Ref PheBeeBucket
          PheBeeDynamoTable: !Ref DynamoDBTable
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeDynamoDBReadPolicy
        - !Ref PheBeeS3WritePolicy

  ResetDatabaseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ResetDatabaseFunction
      CodeUri: functions
      Handler: reset_database.lambda_handler
      MemorySize: 512
      Timeout: 300
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          NeptuneClusterIdentifier: !Ref PheBeeNeptuneCluster
          PheBeeDynamoTable: !Ref DynamoDBTable
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneResetPolicy
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeDynamoDBWritePolicy
        - !Ref PheBeeDynamoDBReadPolicy

  CreateEvidenceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateEvidenceFunction
      CodeUri: functions
      Handler: create_evidence.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          ICEBERG_DATABASE: !Ref IcebergDatabase
          ICEBERG_EVIDENCE_TABLE: !Ref IcebergEvidenceTable
          PHEBEE_BUCKET_NAME: !Ref PheBeeBucket
          EVIDENCE_TABLE: !Sub ${AppName}_evidence
          Region: !Sub ${AWS::Region}
      Policies:
        - !Ref PheBeeIcebergPolicy

  GetEvidenceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetEvidenceFunction
      CodeUri: functions
      Handler: get_evidence.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          ICEBERG_DATABASE: !Ref IcebergDatabase
          ICEBERG_EVIDENCE_TABLE: !Ref IcebergEvidenceTable
          PHEBEE_BUCKET_NAME: !Ref PheBeeBucket
          EVIDENCE_TABLE: !Sub ${AppName}_evidence
          Region: !Sub ${AWS::Region}
      Policies:
        - !Ref PheBeeIcebergPolicy

  RemoveEvidenceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveEvidenceFunction
      CodeUri: functions
      Handler: remove_evidence.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          ICEBERG_DATABASE: !Ref IcebergDatabase
          ICEBERG_EVIDENCE_TABLE: !Ref IcebergEvidenceTable
          PHEBEE_BUCKET_NAME: !Ref PheBeeBucket
          EVIDENCE_TABLE: !Sub ${AppName}_evidence
          Region: !Sub ${AWS::Region}
      Policies:
        - !Ref PheBeeIcebergPolicy

  QueryEvidenceByRunFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-QueryEvidenceByRunFunction
      CodeUri: functions
      Handler: query_evidence_by_run.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          ICEBERG_DATABASE: !Ref IcebergDatabase
          ICEBERG_EVIDENCE_TABLE: !Ref IcebergEvidenceTable
          PHEBEE_BUCKET_NAME: !Ref PheBeeBucket
      Policies:
        - !Ref PheBeeIcebergPolicy

  CreateTermLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateTermLinkFunction
      CodeUri: functions
      Handler: create_term_link.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy

  GetTermLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetTermLinkFunction
      CodeUri: functions
      Handler: get_term_link.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          ICEBERG_DATABASE: !Ref IcebergDatabase
          ICEBERG_EVIDENCE_TABLE: !Ref IcebergEvidenceTable
          PHEBEE_BUCKET_NAME: !Ref PheBeeBucket
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeIcebergPolicy

  RemoveTermLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveTermLinkFunction
      CodeUri: functions
      Handler: remove_term_link.lambda_handler
      MemorySize: 512
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  PrepareSubjectTermLinksPayloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-PrepareSubjectTermLinksPayloadFunction
      CodeUri: functions
      Handler: prepare_subject_term_links_payload.lambda_handler
      MemorySize: 512
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2

  ResolveSubjectMappingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ResolveSubjectMappingsFunction
      CodeUri: functions
      Handler: resolve_subject_mappings.lambda_handler
      MemorySize: 10240
      Timeout: 900
      Environment:
        Variables:
          PheBeeDynamoTable: !Ref DynamoDBTable
      Layers:
        - !Ref PheBeeUtilsLayer
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref PheBeeBucket
        - S3WritePolicy:
            BucketName: !Ref PheBeeBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable

  ValidateBulkImportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ValidateBulkImportFunction
      CodeUri: functions
      Handler: validate_bulk_import.lambda_handler
      MemorySize: 256
      Timeout: 30
      Layers:
        - !Ref PheBeeUtilsLayer
      Policies:
        - !Ref PheBeeS3ReadPolicy

  StartNeptuneBulkLoadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-StartNeptuneBulkLoadFunction
      CodeUri: functions
      Handler: start_neptune_bulk_load.lambda_handler
      MemorySize: 256
      Timeout: 60
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NEPTUNE_CLUSTER_ENDPOINT: !GetAtt PheBeeNeptuneCluster.Endpoint
          NeptuneEndpoint: !Sub "https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}"
          Region: !Ref AWS::Region
          NEPTUNE_LOAD_ROLE_ARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/phebee-neptune-loader-role-${AppName}"
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneLoadPolicy
        - !Ref PheBeeS3ReadPolicy

  CheckNeptuneBulkLoadStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CheckNeptuneBulkLoadStatusFunction
      CodeUri: functions
      Handler: check_neptune_bulk_load_status.lambda_handler
      MemorySize: 256
      Timeout: 30
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NEPTUNE_CLUSTER_ENDPOINT: !GetAtt PheBeeNeptuneCluster.Endpoint
          NeptuneEndpoint: !Sub "https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}"
          Region: !Ref AWS::Region
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneLoadPolicy

  GenerateTTLManifestFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GenerateTTLManifestFunction
      CodeUri: functions
      Handler: generate_ttl_manifest.lambda_handler
      MemorySize: 512
      Timeout: 900
      Layers:
        - !Ref PheBeeUtilsLayer
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - athena:StartQueryExecution
                - athena:GetQueryExecution
                - athena:GetQueryResults
                - athena:StopQueryExecution
                - athena:GetWorkGroup
              Resource: "*"
            - Effect: Allow
              Action:
                - glue:GetTable
                - glue:GetDatabase
              Resource: "*"
            - Effect: Allow
              Action:
                - s3:GetBucketLocation
                - s3:GetObject
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:PutObject
                - s3:DeleteObject
              Resource: 
                - !Sub "arn:aws:s3:::${PheBeeBucket}/*"
                - !Sub "arn:aws:s3:::${PheBeeBucket}"

  GenerateTTLFromIcebergFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GenerateTTLFromIcebergFunction
      CodeUri: functions
      Handler: generate_ttl_from_iceberg.lambda_handler
      MemorySize: 512
      Timeout: 900
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - athena:StartQueryExecution
                - athena:GetQueryExecution
                - athena:GetQueryResults
                - athena:StopQueryExecution
                - athena:GetWorkGroup
              Resource: "*"
            - Effect: Allow
              Action:
                - glue:GetTable
                - glue:GetDatabase
                - glue:GetPartitions
              Resource: "*"
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
              Resource: !GetAtt DynamoDBTable.Arn
            - Effect: Allow
              Action:
                - s3:GetBucketLocation
                - s3:GetObject
                - s3:ListBucket
                - s3:ListBucketMultipartUploads
                - s3:ListMultipartUploadParts
                - s3:AbortMultipartUpload
                - s3:PutObject
                - s3:DeleteObject
              Resource: 
                - !Sub "arn:aws:s3:::${PheBeeBucket}/*"
                - !Sub "arn:aws:s3:::${PheBeeBucket}"

  NotifyBulkImportCompleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-NotifyBulkImportCompleteFunction
      CodeUri: functions
      Handler: notify_bulk_import_complete.lambda_handler
      MemorySize: 256
      Timeout: 30
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          PheBeeBus: !Ref PheBeeBus
      Policies:
        - !Ref PheBeePutEventsPolicy

  NotifyBulkImportFailureFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-NotifyBulkImportFailureFunction
      CodeUri: functions
      Handler: notify_bulk_import_failure.lambda_handler
      MemorySize: 256
      Timeout: 30
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          PheBeeBus: !Ref PheBeeBus
      Policies:
        - !Ref PheBeePutEventsPolicy

  # EMR Serverless Application
  EMRServerlessApplication:
    Type: AWS::EMRServerless::Application
    Properties:
      Name: !Sub ${AppName}-BulkEvidenceProcessor
      Type: Spark
      ReleaseLabel: emr-7.0.0      
      AutoStartConfiguration:
        Enabled: true
      AutoStopConfiguration:
        Enabled: true
        IdleTimeoutMinutes: 15

  # EMR Execution Role
  EMRExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${AppName}-EMRExecutionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: emr-serverless.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt PheBeeBucket.Arn
                  - !Sub "${PheBeeBucket.Arn}/*"
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: 
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/emr-serverless/*"
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/emr-containers/*"
        - PolicyName: GlueAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - glue:GetDatabase
                  - glue:GetTable
                  - glue:GetPartitions
                  - glue:CreateTable
                  - glue:UpdateTable
                  - glue:BatchCreatePartition
                  - glue:BatchUpdatePartition
                Resource: "*"
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:BatchGetItem
                  - dynamodb:GetItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource: !GetAtt DynamoDBTable.Arn
        - PolicyName: LakeFormationAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lakeformation:GetDataAccess
                  - lakeformation:GetWorkUnits
                  - lakeformation:StartQueryPlanning
                  - lakeformation:GetWorkUnitResults
                  - lakeformation:GetQueryState
                  - lakeformation:GetQueryStatistics
                Resource: "*"

  # Step Function for Bulk Import
  BulkImportStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub ${AppName}-BulkImportStateMachine
      Role: !GetAtt BulkImportStateMachineRole.Arn
      DefinitionUri: statemachine/bulk_evidence_import.asl.json
      DefinitionSubstitutions:
        ValidateBulkImportFunction: !GetAtt ValidateBulkImportFunction.Arn
        ResolveSubjectMappingsFunction: !GetAtt ResolveSubjectMappingsFunction.Arn
        EMRServerlessApplicationId: !Ref EMRServerlessApplication
        EMRExecutionRoleArn: !GetAtt EMRExecutionRole.Arn
        PheBeeBucketName: !Ref PheBeeBucket
        IcebergDatabase: !Ref IcebergDatabase
        IcebergEvidenceTable: !Ref IcebergEvidenceTable
        NeptuneClusterEndpoint: !GetAtt PheBeeNeptuneCluster.Endpoint
        StartNeptuneBulkLoadFunction: !GetAtt StartNeptuneBulkLoadFunction.Arn
        CheckNeptuneBulkLoadStatusFunction: !GetAtt CheckNeptuneBulkLoadStatusFunction.Arn
        GenerateTTLManifestFunction: !GetAtt GenerateTTLManifestFunction.Arn
        GenerateTTLFromIcebergFunction: !GetAtt GenerateTTLFromIcebergFunction.Arn
        NotifyBulkImportCompleteFunction: !GetAtt NotifyBulkImportCompleteFunction.Arn
        NotifyBulkImportFailureFunction: !GetAtt NotifyBulkImportFailureFunction.Arn
        DynamoDBTableName: !Ref DynamoDBTable

  BulkImportStateMachineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppName}-BulkImportStateMachineRole"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: states.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: LambdaInvoke
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt ValidateBulkImportFunction.Arn
                  - !GetAtt ResolveSubjectMappingsFunction.Arn
                  - !GetAtt StartNeptuneBulkLoadFunction.Arn
                  - !GetAtt CheckNeptuneBulkLoadStatusFunction.Arn
                  - !GetAtt GenerateTTLManifestFunction.Arn
                  - !GetAtt GenerateTTLFromIcebergFunction.Arn
                  - !GetAtt NotifyBulkImportCompleteFunction.Arn
                  - !GetAtt NotifyBulkImportFailureFunction.Arn
        - PolicyName: EMRServerlessAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - emr-serverless:StartJobRun
                  - emr-serverless:GetJobRun
                  - emr-serverless:CancelJobRun
                Resource: 
                  - !Sub "arn:aws:emr-serverless:${AWS::Region}:${AWS::AccountId}:/applications/${EMRServerlessApplication}"
                  - !Sub "arn:aws:emr-serverless:${AWS::Region}:${AWS::AccountId}:/applications/${EMRServerlessApplication}/jobruns/*"
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource: !GetAtt EMRExecutionRole.Arn
        - PolicyName: EventBridgeAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - events:PutRule
                  - events:DeleteRule
                  - events:DescribeRule
                  - events:EnableRule
                  - events:DisableRule
                  - events:ListTargetsByRule
                  - events:PutTargets
                  - events:RemoveTargets
                Resource: 
                  - !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/${AppName}-*"
                  - !Sub "arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/StepFunctionsGetEventsForEMRServerlessJobRule"

  FinalizeBulkUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-FinalizeBulkUploadFunction
      CodeUri: functions
      Handler: finalize_bulk_upload.lambda_handler
      MemorySize: 1024
      Timeout: 300
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeBucketName: !Ref PheBeeBucket
          LoaderRoleArn: !GetAtt NeptuneLoaderRole.Arn
          PheBeeDynamoTable: !Ref DynamoDBTable
          BulkLoadMonitorSFNArn: !Ref BulkLoadMonitorSFN
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneLoadPolicy     # start loader jobs
        - !Ref PheBeeDynamoDBReadPolicy    # read run/batch status
        - !Ref PheBeeDynamoDBWritePolicy   # mark run finalized / store loader IDs
        - Statement:
          - Effect: Allow
            Action:
              - states:StartExecution
            Resource:
              - !Ref BulkLoadMonitorSFN

  CheckBulkLoadStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CheckBulkLoadStatusFunction
      CodeUri: functions
      Handler: check_bulk_load_status.lambda_handler
      MemorySize: 256
      Timeout: 60
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneLoadPolicy

  FireBulkEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-FireBulkEventFunction
      CodeUri: functions
      Handler: fire_bulk_event.lambda_handler
      MemorySize: 256
      Timeout: 60
      Layers:
        - !Ref PheBeeUtilsLayer
      Environment:
        Variables:
          PheBeeBus: !Ref PheBeeBus
      Policies:
        - !Ref PheBeePutEventsPolicy

  CreateEvidenceTableFunction:
    Type: AWS::Serverless::Function
    Condition: ShouldCreateEvidenceTable
    Properties:
      FunctionName: !Sub "${AppName}-CreateEvidenceTableFunction"
      CodeUri: functions/
      Handler: create_evidence_table.lambda_handler
      Runtime: python3.11
      Timeout: 120
      MemorySize: 256
      Role: !GetAtt CreateEvidenceTableRole.Arn

  #################
  # Step Functions
  #################

  InstallRDFXMLSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/install_rdfxml.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        StartLoadFunctionArn: !Ref StartLoadFunction
        GetLoadStatusFunctionArn: !Ref GetLoadStatusFunction
        Region: !Sub ${AWS::Region}
        LoaderRole: !GetAtt NeptuneLoaderRole.Arn
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt StartLoadFunction.Arn
              - !GetAtt GetLoadStatusFunction.Arn

  UpdateHPOSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/update_hpo.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        InstallRDFXMLSFNArn: !Ref InstallRDFXMLSFN
        DownloadGithubReleaseFunctionArn: !Ref DownloadGithubReleaseFunction
        UpdateInstallTimestampFunctionArn: !Ref UpdateInstallTimestampFunction
        PheBeeBus: !Ref PheBeeBus
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt DownloadGithubReleaseFunction.Arn
              - !GetAtt UpdateInstallTimestampFunction.Arn
          - Effect: Allow
            Action: states:StartExecution
            Resource:
              - !GetAtt InstallRDFXMLSFN.Arn

  UpdateMondoSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/update_mondo.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        InstallRDFXMLSFNArn: !Ref InstallRDFXMLSFN
        DownloadGithubReleaseFunctionArn: !Ref DownloadGithubReleaseFunction
        UpdateInstallTimestampFunctionArn: !Ref UpdateInstallTimestampFunction
        PheBeeBus: !Ref PheBeeBus
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt DownloadGithubReleaseFunction.Arn
              - !GetAtt UpdateInstallTimestampFunction.Arn
          - Effect: Allow
            Action: states:StartExecution
            Resource:
              - !GetAtt InstallRDFXMLSFN.Arn

  UpdateECOSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/update_eco.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        InstallRDFXMLSFNArn: !Ref InstallRDFXMLSFN
        DownloadGithubReleaseFunctionArn: !Ref DownloadGithubReleaseFunction
        UpdateInstallTimestampFunctionArn: !Ref UpdateInstallTimestampFunction
        PheBeeBus: !Ref PheBeeBus
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt DownloadGithubReleaseFunction.Arn
              - !GetAtt UpdateInstallTimestampFunction.Arn
          - Effect: Allow
            Action: states:StartExecution
            Resource:
              - !GetAtt InstallRDFXMLSFN.Arn


  ImportPhenopacketsSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub ImportPhenopacketsSFN-${AppName}
      DefinitionUri: statemachine/import_phenopackets.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        ParsePhenopacketCollectionFunctionArn: !Ref ParsePhenopacketCollectionFunction
        ProcessPhenopacketFunctionArn: !Ref ProcessPhenopacketFunction
        CreateSubjectFunctionArn: !Ref CreateSubjectFunction
        CreateTermLinkFunctionArn: !Ref CreateTermLinkFunction
        PrepareSubjectTermLinksPayloadFunctionArn: !Ref PrepareSubjectTermLinksPayloadFunction
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - !Ref PheBeeS3ReadPolicy
        - !Ref PheBeeS3WritePolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt CreateSubjectFunction.Arn
              - !GetAtt CreateTermLinkFunction.Arn
              - !GetAtt ParsePhenopacketCollectionFunction.Arn
              - !GetAtt ProcessPhenopacketFunction.Arn
              - !GetAtt PrepareSubjectTermLinksPayloadFunction.Arn
          - Effect: Allow
            Action:
              - states:StartExecution
            Resource:
              - !Sub arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:ImportPhenopacketsSFN-${AppName}


  #################
  # DynamoDB
  #################

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  #################
  # Iceberg Tables
  #################

  IcebergGlueDatabase:
    Type: AWS::Glue::Database
    Condition: ShouldCreateEvidenceTable
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Ref IcebergDatabase

  CreateEvidenceTableResource:
    Type: Custom::IcebergTable
    Condition: ShouldCreateEvidenceTable
    DependsOn: IcebergGlueDatabase
    Properties:
      ServiceToken: !GetAtt CreateEvidenceTableFunction.Arn
      Database: !Ref IcebergDatabase
      Table: !Ref IcebergEvidenceTable
      S3Location: !Sub "s3://${PheBeeBucket}/iceberg/evidence/"
      QueryResultsS3: !Sub "s3://${PheBeeBucket}/athena-results/${AppName}/"
      Version: "4.0"

  #################
  # S3 Storage
  #################

  PheBeeBucket:
    Type: AWS::S3::Bucket
    Condition: ShouldCreateS3Bucket
    Properties:
      LoggingConfiguration: 
        !If 
          - ShouldEnableS3Logging
          - DestinationBucketName: !Ref S3AccessLogBucketName
            LogFilePrefix: !Ref S3AccessLogPrefix
          - !Ref AWS::NoValue
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm:  AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      ObjectLockEnabled: false

  PheBeeBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: ShouldCreateS3Bucket
    Properties:
      Bucket: !Ref PheBeeBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowSSLRequestsOnly # AWS Foundational Security Best Practices v1.0.0 S3.5
            Action: "s3:*"
            Principal: "*"
            Effect: "Deny"
            Condition:
              Bool:
                "aws:SecureTransport": "false"
            Resource:
              - !Sub "arn:${AWS::Partition}:s3:::${PheBeeBucket}"
              - !Sub "arn:${AWS::Partition}:s3:::${PheBeeBucket}/*"

  #################
  # HTTP API
  #################

  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      DefinitionBody:
        'Fn::Transform':
          Name: 'AWS::Include'
          Parameters:
            Location: 'api.yaml'

  BulkLoadMonitorSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/bulk_load_monitor.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        CheckBulkLoadStatusFunctionArn: !GetAtt CheckBulkLoadStatusFunction.Arn
        FireBulkEventFunctionArn: !GetAtt FireBulkEventFunction.Arn
      Type: STANDARD
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt CheckBulkLoadStatusFunction.Arn
              - !GetAtt FireBulkEventFunction.Arn
          - Effect: Allow
            Action:
              - logs:CreateLogDelivery
              - logs:GetLogDelivery
              - logs:UpdateLogDelivery
              - logs:DeleteLogDelivery
              - logs:ListLogDeliveries
              - logs:PutResourcePolicy
              - logs:DescribeResourcePolicies
              - logs:DescribeLogGroups
            Resource: "*"

  #################
  # EventBridge
  #################

  PheBeeBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub phebee-bus-${AppName}

  ####################
  # Scheduled Updates
  ####################

  UpdateHPOScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableScheduledOntologyUpdate
    Properties:
      Name: !Sub UpdateHPO-OnSchedule-${AppName}
      ScheduleExpression: !Ref HPOScheduleExpression
      State: ENABLED
      Targets:
        - Arn: !GetAtt UpdateHPOSFN.Arn
          Id: "UpdateHPO"
          RoleArn: !GetAtt UpdateOntologyInvokeRole.Arn
  
  UpdateMondoScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableScheduledOntologyUpdate
    Properties:
      Name: !Sub UpdateMondo-OnSchedule-${AppName}
      ScheduleExpression: !Ref MondoScheduleExpression
      State: ENABLED
      Targets:
        - Arn: !GetAtt UpdateMondoSFN.Arn
          Id: "UpdateMondo"
          RoleArn: !GetAtt UpdateOntologyInvokeRole.Arn

  UpdateECOScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableScheduledOntologyUpdate
    Properties:
      Name: !Sub UpdateECO-OnSchedule-${AppName}
      ScheduleExpression: !Ref ECOScheduleExpression
      State: ENABLED
      Targets:
        - Arn: !GetAtt UpdateECOSFN.Arn
          Id: "UpdateECO"
          RoleArn: !GetAtt UpdateOntologyInvokeRole.Arn

Outputs:
  UpdateHPOSFNArn:
    Value: !Ref UpdateHPOSFN

  UpdateMondoSFNArn:
    Value: !Ref UpdateMondoSFN

  UpdateECOSFNArn:
    Value: !Ref UpdateECOSFN

  CreateProjectFunctionArn:
    Value: !Ref CreateProjectFunction

  ResetDatabaseFunctionArn:
    Value: !Ref ResetDatabaseFunction

  CheckBulkLoadStatusFunctionArn:
    Value: !GetAtt CheckBulkLoadStatusFunction.Arn
    Export:
      Name: !Sub "${AppName}-CheckBulkLoadStatusFunctionArn"

  FireBulkEventFunctionArn:
    Value: !GetAtt FireBulkEventFunction.Arn
    Export:
      Name: !Sub "${AppName}-FireBulkEventFunctionArn"

  BulkLoadMonitorSFNArn:
    Value: !Ref BulkLoadMonitorSFN
    Export:
      Name: !Sub "${AppName}-BulkLoadMonitorSFNArn"

  BulkImportStateMachineArn:
    Value: !Ref BulkImportStateMachine
    Export:
      Name: !Sub "${AppName}-BulkImportStateMachineArn"

  EMRServerlessApplicationId:
    Value: !Ref EMRServerlessApplication
    Export:
      Name: !Sub "${AppName}-EMRServerlessApplicationId"

  ValidateBulkImportFunctionArn:
    Value: !GetAtt ValidateBulkImportFunction.Arn
    Export:
      Name: !Sub "${AppName}-ValidateBulkImportFunctionArn"

  StartNeptuneBulkLoadFunctionArn:
    Value: !GetAtt StartNeptuneBulkLoadFunction.Arn
    Export:
      Name: !Sub "${AppName}-StartNeptuneBulkLoadFunctionArn"

  PheBeeBucketName:
    Value: !Ref PheBeeBucket
    Export:
      Name: !Sub "${AppName}-PheBeeBucketName"

  PheBeeBucketArn:
    Value: !GetAtt PheBeeBucket.Arn
    Export:
      Name: !Sub "${AppName}-PheBeeBucketArn"

  CheckNeptuneBulkLoadStatusFunctionArn:
    Value: !GetAtt CheckNeptuneBulkLoadStatusFunction.Arn
    Export:
      Name: !Sub "${AppName}-CheckNeptuneBulkLoadStatusFunctionArn"

  GetLoadStatusFunctionArn:
    Value: !GetAtt GetLoadStatusFunction.Arn
    Export:
      Name: !Sub "${AppName}-GetLoadStatusFunctionArn"

  QueryProvenanceFunctionArn:
    Value: !GetAtt QueryProvenanceFunction.Arn
    Export:
      Name: !Sub "${AppName}-QueryProvenanceFunctionArn"

  QueryEvidenceByRunFunctionArn:
    Value: !GetAtt QueryEvidenceByRunFunction.Arn
    Export:
      Name: !Sub "${AppName}-QueryEvidenceByRunFunctionArn"

  DynamoDBTableName:
    Description: Table name of the PheBee DynamoDB table
    Value: !Ref DynamoDBTable
    Export:
      Name: !Sub ${AppName}-DynamoDBTableName

  Region:
    Value: !Sub ${AWS::Region}

  NeptuneEndpoint:
    Value: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}

  NeptuneClusterIdentifier:
    Value: !Ref PheBeeNeptuneCluster
  
  HttpApiUrl:
    Description: Base URL for the HTTP API
    Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"

  AppName:
    Description: Application name used for resource naming
    Value: !Ref AppName

  PheBeeBus:
    Description: Name of the custom EventBridge bus for PheBee events
    Value: !Ref PheBeeBus
    Export:
      Name: !Sub "${AppName}-PheBeeBus"