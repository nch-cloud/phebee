AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: PheBee
Globals:
  Function:
    Timeout: 90
    Architectures:
      - arm64
    Tracing: Active
    Runtime: python3.11
    Environment:
      Variables:
        POWERTOOLS_SERVICE_NAME: phebee

Parameters:
  AppName:
    Type: String
    Description: "Application name used for resource naming (e.g., phebee-dev-2)"
    Default: phebee
    AllowedPattern: "^[a-z0-9-]+$"
    ConstraintDescription: "Must contain only lowercase letters, numbers, and hyphens"

  VpcId:
    Default: false
    Description: "VPC in which Neptune is supposed to run. ex: vpc-xxxxxxxxxxxxxx"
    Type: String  

  SubnetId1:
    Default: false
    Description: "Subnet in the VPC which Neptune is supposed to run. ex: subnet-xxxxxxxxxxxxxx"
    Type: String  

  SubnetId2:
    Default: false
    Description: "Subnet in the VPC which Neptune is supposed to run. ex: subnet-xxxxxxxxxxxxxx"
    Type: String   

  CreateS3Bucket:
    Default: true
    AllowedValues:
      - true
      - false
    Description: Create a new S3 bucket to hold PheBee data
    Type: String

  S3AccessLogBucketName:
    Type: String
    Description: Optional. An existing bucket where access logs should be delivered.
    Default: ""
  
  S3AccessLogPrefix:
    Type: String
    Description: Optional. Prefix (folder path) for the logs in the log bucket.
    Default: phebee-access-logs/

  RunOntologyUpdatesOnSchedule:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]
    Description: Whether to enable scheduled ontology updates

  HPOScheduleExpression:
    Type: String
    Default: "cron(0 9 * * ? *)"  # 4 AM EST = 9 UTC
    Description: Cron expression for HPO update

  MondoScheduleExpression:
    Type: String
    Default: "cron(10 9 * * ? *)"  # 4:10 AM EST = 9:10 UTC
    Description: Cron expression for Mondo update

  ECOScheduleExpression:
    Type: String
    Default: "cron(20 9 * * ? *)"  # 4:20 AM EST = 9:20 UTC
    Description: Cron expression for ECO update

Conditions:
  ShouldCreateS3Bucket: !Equals [!Ref CreateS3Bucket, true]

  ShouldEnableS3Logging: !Not [!Equals [!Ref S3AccessLogBucketName, ""]]

  EnableScheduledOntologyUpdate: !Equals [!Ref RunOntologyUpdatesOnSchedule, "true"]

Resources:
  SAMLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/step_functions/phebee-${AppName}

  #################
  # IAM
  #################

  PheBeeStepFunctionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - logs:CreateLogDelivery
              - logs:CreateLogStream
              - logs:GetLogDelivery
              - logs:UpdateLogDelivery
              - logs:DeleteLogDelivery
              - logs:ListLogDeliveries
              - logs:PutLogEvents
              - logs:PutResourcePolicy
              - logs:DescribeResourcePolicies
              - logs:DescribeLogGroups
            Resource: "*"
          - Effect: Allow
            Action:
              - events:PutTargets
              - events:PutRule
              - events:DescribeRule
              - events:PutEvents
            Resource: !GetAtt PheBeeBus.Arn
          - Effect: Allow
            Action:
              - events:PutRule
              - events:PutTargets
              - events:DescribeRule
            Resource: !Sub arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/StepFunctionsGetEventsForStepFunctionsExecutionRule

  PheBeeAPIRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
        - !Ref PheBeeAPIPolicy

  PheBeeAPIPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt GetSourceInfoFunction.Arn
              - !GetAtt CreateProjectFunction.Arn
              - !GetAtt CreateSubjectFunction.Arn
              - !GetAtt ExportPhenopacketsFunction.Arn
              - !GetAtt GetSubjectFunction.Arn
              - !GetAtt GetSubjectsPhenotypesFunction.Arn
              - !GetAtt RemoveSubjectFunction.Arn
              - !GetAtt RemoveProjectFunction.Arn
              - !GetAtt CreateEncounterFunction.Arn
              - !GetAtt GetEncounterFunction.Arn
              - !GetAtt RemoveEncounterFunction.Arn
              - !GetAtt CreateClinicalNoteFunction.Arn
              - !GetAtt GetClinicalNoteFunction.Arn
              - !GetAtt RemoveClinicalNoteFunction.Arn
              - !GetAtt CreateCreatorFunction.Arn
              - !GetAtt GetCreatorFunction.Arn
              - !GetAtt RemoveCreatorFunction.Arn
              - !GetAtt CreateTextAnnotationFunction.Arn
              - !GetAtt GetTextAnnotationFunction.Arn
              - !GetAtt RemoveTextAnnotationFunction.Arn
              - !GetAtt CreateTermLinkFunction.Arn
              - !GetAtt GetTermLinkFunction.Arn
              - !GetAtt RemoveTermLinkFunction.Arn
              - !GetAtt QueryProvenanceFunction.Arn
          - Effect: Allow
            Action:
              - states:StartSyncExecution
            Resource:
              - !GetAtt ImportPhenopacketsSFN.Arn

  PheBeeS3ReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:ListBucket
              - s3:PutObject
            Resource:
              - !GetAtt PheBeeBucket.Arn
              - !Sub
                - ${Arn}/*
                - Arn: !GetAtt PheBeeBucket.Arn
  
  PheBeeS3WritePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:PutObject
            Resource:
              - !Sub
                - ${Arn}/*
                - Arn: !GetAtt PheBeeBucket.Arn
  
  PheBeeDynamoDBReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:Scan
              - dynamodb:Query
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:BatchGetItem
              - dynamodb:TransactGetItems
            Resource:
              - !GetAtt DynamoDBTable.Arn
  
  PheBeeDynamoDBWritePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:BatchWriteItem
              - dynamodb:TransactWriteItems
              - dynamodb:ConditionCheckItem
            Resource:
              - !GetAtt DynamoDBTable.Arn

  PheBeeNeptuneReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:ReadDataViaQuery
              - neptune-db:GetEngineStatus
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId
          - Effect: Allow
            Action:
              - rds:DescribeDBClusters
            Resource: !Sub arn:${AWS::Partition}:rds:${AWS::Region}:${AWS::AccountId}:cluster:${AppName}-neptune-cluster
  
  PheBeeNeptuneLoadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:StartLoaderJob
              - neptune-db:GetLoaderJobStatus
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId

  PheBeeNeptuneWritePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:WriteDataViaQuery
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId

  PheBeeNeptuneDeletePolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:DeleteDataViaQuery
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId

  PheBeeNeptuneResetPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - neptune-db:ResetDatabase
            Resource: !Sub
              - arn:${AWS::Partition}:neptune-db:${AWS::Region}:${AWS::AccountId}:${ClusterId}/*
              - ClusterId: !GetAtt PheBeeNeptuneCluster.ClusterResourceId

  PheBeePutEventsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - events:PutEvents
            Resource:
              - !Sub arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:event-bus/${PheBeeBus}

  NeptuneLoaderRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub phebee-neptune-loader-role-${AppName}
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service: rds.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref PheBeeS3ReadPolicy

  UpdateOntologyInvokeRole:
    Type: AWS::IAM::Role
    Condition: EnableScheduledOntologyUpdate
    Properties:
      RoleName: !Sub PheBeeInvokeOntologyUpdatersRole-${AppName}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: "AllowEventBridgeToStartUpdaters"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: "states:StartExecution"
                Resource:
                  - !GetAtt UpdateHPOSFN.Arn
                  - !GetAtt UpdateMondoSFN.Arn
                  - !GetAtt UpdateECOSFN.Arn

  #################
  # Neptune Cluster
  #################
  PheBeeNeptuneSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Amazon Neptune Created
      GroupName: !Sub phebee-neptune-sg-${AppName}
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - SourceSecurityGroupId: !Ref PheBeeLambdaSecurityGroup
          IpProtocol: tcp
          FromPort: 8182
          ToPort: 8182
          Description: PheBee Neptune

  PheBeeNeptuneSubnetGroup:
    Type: AWS::Neptune::DBSubnetGroup
    Properties:
      SubnetIds:
      - !Ref SubnetId1
      - !Ref SubnetId2
      DBSubnetGroupDescription: Subnet group for PheBee subnets
      DBSubnetGroupName: !Sub phebee-neptune-subnets-${AppName}

  PheBeeNeptuneCluster:
    Type: AWS::Neptune::DBCluster
    Properties:
      DBClusterIdentifier: !Sub ${AppName}-neptune-cluster
      StorageEncrypted: true
      # Associating the role here is necessary to pass it as the role to use for our bulk loader
      AssociatedRoles:
        - RoleArn: !GetAtt NeptuneLoaderRole.Arn
      ServerlessScalingConfiguration:
        MinCapacity: 1
        MaxCapacity: 16
      PreferredMaintenanceWindow: mon:09:10-mon:09:40
      IamAuthEnabled: true
      DBSubnetGroupName: !Ref PheBeeNeptuneSubnetGroup
      PreferredBackupWindow: 03:59-04:29
      DBPort: 8182
      VpcSecurityGroupIds:
        - !Ref PheBeeNeptuneSecurityGroup
      CopyTagsToSnapshot: true
      DBClusterParameterGroupName: default.neptune1.4
      BackupRetentionPeriod: 7
      EnableCloudwatchLogsExports:
      - audit
      - slowquery

  PheBeeNeptuneInstance:
    Type: AWS::Neptune::DBInstance
    Properties:
      DBInstanceClass: db.r5.large
      DBClusterIdentifier: !Ref PheBeeNeptuneCluster
      DBSubnetGroupName: !Ref PheBeeNeptuneSubnetGroup
      DBParameterGroupName: default.neptune1.4
      AutoMinorVersionUpgrade: true

  #################
  # Lambdas
  #################

  PheBeeLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Amazon Neptune Created
      GroupName: !Sub phebee-lambda-sg-${AppName}
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        # Egress is needed to allow test suite to invoke lambdas and receive a response
        # TODO : Might be able to lock this down to specific ports to further tighten security
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  DownloadGithubReleaseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-DownloadGithubReleaseFunction
      CodeUri: functions
      Handler: download_github_release.lambda_handler
      MemorySize: 1024
      Environment:
        Variables:
          PheBeeBucketName: !Ref PheBeeBucket
          PheBeeDynamoTable: !Ref DynamoDBTable
      Policies:
        - !Ref PheBeeS3ReadPolicy
        - !Ref PheBeeDynamoDBWritePolicy
        - !Ref PheBeeDynamoDBReadPolicy
        - Statement:
          - Effect: Allow
            Action: states:StartExecution
            Resource:
              - !Sub arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:InstallRDFXMLSFN


  UpdateInstallTimestampFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-UpdateInstallTimestampFunction
      CodeUri: functions
      Handler: update_install_timestamp.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          PheBeeDynamoTable: !Ref DynamoDBTable
      Policies:
        - !Ref PheBeeDynamoDBReadPolicy
        - !Ref PheBeeDynamoDBWritePolicy

  StartLoadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-StartLoadFunction
      CodeUri: functions
      Handler: start_load.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneLoadPolicy

  GetLoadStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetLoadStatusFunction
      CodeUri: functions
      Handler: get_load_status.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneLoadPolicy

  GetSourceInfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetSourceInfoFunction
      CodeUri: functions
      Handler: get_source_info.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          PheBeeDynamoTable: !Ref DynamoDBTable
      Policies:
        - !Ref PheBeeDynamoDBReadPolicy

  GetSubjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetSubjectFunction
      CodeUri: functions
      Handler: get_subject.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeDynamoTable: !Ref DynamoDBTable
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeDynamoDBReadPolicy

  CreateSubjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateSubjectFunction
      CodeUri: functions
      Handler: create_subject.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeBus: !Ref PheBeeBus
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy
        - !Ref PheBeePutEventsPolicy

  RemoveSubjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveSubjectFunction
      CodeUri: functions
      Handler: remove_subject.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  CreateProjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateProjectFunction
      CodeUri: functions
      Handler: create_project.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy

  RemoveProjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveProjectFunction
      CodeUri: functions
      Handler: remove_project.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  ParsePhenopacketCollectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ParsePhenopacketCollectionFunction
      CodeUri: functions
      Handler: parse_phenopacket_collection.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          PheBeeBucketName: !Ref PheBeeBucket
      Policies:
        - !Ref PheBeeS3ReadPolicy
        - !Ref PheBeeS3WritePolicy

  ProcessPhenopacketFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ProcessPhenopacketFunction
      CodeUri: functions
      Handler: process_phenopacket.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          PheBeeBucketName: !Ref PheBeeBucket

  ExportPhenopacketsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ExportPhenopacketsFunction
      CodeUri: functions
      Handler: export_phenopackets.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          PheBeeBucketName: !Ref PheBeeBucket
          PheBeeDynamoTable: !Ref DynamoDBTable
      Policies:
        - !Ref PheBeeS3ReadPolicy
        - !Ref PheBeeS3WritePolicy
        - !Ref PheBeeDynamoDBReadPolicy

  QueryProvenanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-QueryProvenanceFunction
      CodeUri: functions/
      Handler: query_provenance.lambda_handler
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeNeptuneSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy

  GetSubjectsPhenotypesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetSubjectsPhenotypesFunction
      CodeUri: functions
      Handler: get_subjects_pheno.lambda_handler
      MemorySize: 2048
      Timeout: 300
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeBus: !Ref PheBeeBus
          PheBeeBucketName: !Ref PheBeeBucket
          PheBeeDynamoTable: !Ref DynamoDBTable
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeS3ReadPolicy
        - !Ref PheBeeS3WritePolicy
        - !Ref PheBeeDynamoDBReadPolicy

  ResetDatabaseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-ResetDatabaseFunction
      CodeUri: functions
      Handler: reset_database.lambda_handler
      MemorySize: 512
      Timeout: 300
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          NeptuneClusterIdentifier: !Ref PheBeeNeptuneCluster
          PheBeeDynamoTable: !Ref DynamoDBTable
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneResetPolicy
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeDynamoDBWritePolicy
        - !Ref PheBeeDynamoDBReadPolicy

  CreateEncounterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateEncounterFunction
      CodeUri: functions
      Handler: create_encounter.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy

  GetEncounterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetEncounterFunction
      CodeUri: functions
      Handler: get_encounter.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy

  RemoveEncounterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveEncounterFunction
      CodeUri: functions
      Handler: remove_encounter.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  CreateClinicalNoteFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateClinicalNoteFunction
      CodeUri: functions
      Handler: create_clinical_note.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy

  GetClinicalNoteFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetClinicalNoteFunction
      CodeUri: functions
      Handler: get_clinical_note.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy

  RemoveClinicalNoteFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveClinicalNoteFunction
      CodeUri: functions
      Handler: remove_clinical_note.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  CreateCreatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateCreatorFunction
      CodeUri: functions
      Handler: create_creator.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy

  GetCreatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetCreatorFunction
      CodeUri: functions
      Handler: get_creator.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy

  RemoveCreatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveCreatorFunction
      CodeUri: functions
      Handler: remove_creator.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  CreateTextAnnotationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateTextAnnotationFunction
      CodeUri: functions
      Handler: create_text_annotation.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy

  GetTextAnnotationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetTextAnnotationFunction
      CodeUri: functions
      Handler: get_text_annotation.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy

  RemoveTextAnnotationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveTextAnnotationFunction
      CodeUri: functions
      Handler: remove_text_annotation.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  CreateTermLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CreateTermLinkFunction
      CodeUri: functions
      Handler: create_term_link.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneWritePolicy

  GetTermLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-GetTermLinkFunction
      CodeUri: functions
      Handler: get_term_link.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy

  RemoveTermLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-RemoveTermLinkFunction
      CodeUri: functions
      Handler: remove_term_link.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneDeletePolicy

  PrepareSubjectTermLinksPayloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-PrepareSubjectTermLinksPayloadFunction
      CodeUri: functions
      Handler: prepare_subject_term_links_payload.lambda_handler
      MemorySize: 512
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2

  PrepareBulkUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-PrepareBulkUploadFunction
      CodeUri: functions
      Handler: prepare_bulk_upload.lambda_handler
      MemorySize: 512
      Environment:
        Variables:
          PheBeeBucketName: !Ref PheBeeBucket
      Policies:
        - !Ref PheBeeS3WritePolicy
        - !Ref PheBeeDynamoDBWritePolicy
        - !Ref PheBeeDynamoDBReadPolicy

  PerformBulkUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-PerformBulkUploadFunction
      CodeUri: functions
      Handler: perform_bulk_upload.lambda_handler
      MemorySize: 1024
      Timeout: 900
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeBucketName: !Ref PheBeeBucket
          LoaderRoleArn: !GetAtt NeptuneLoaderRole.Arn
          PheBeeDynamoTable: !Ref DynamoDBTable
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeS3ReadPolicy
        - !Ref PheBeeDynamoDBWritePolicy
        - !Ref PheBeeDynamoDBReadPolicy

  FinalizeBulkUploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-FinalizeBulkUploadFunction
      CodeUri: functions
      Handler: finalize_bulk_upload.lambda_handler
      MemorySize: 1024
      Timeout: 300
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
          PheBeeBucketName: !Ref PheBeeBucket
          LoaderRoleArn: !GetAtt NeptuneLoaderRole.Arn
          PheBeeDynamoTable: !Ref DynamoDBTable
          BulkLoadMonitorSFNArn: !Ref BulkLoadMonitorSFN
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneLoadPolicy     # start loader jobs
        - !Ref PheBeeS3ReadPolicy          # list / verify data/prov prefixes
        - !Ref PheBeeDynamoDBReadPolicy    # read run/batch status
        - !Ref PheBeeDynamoDBWritePolicy   # mark run finalized / store loader IDs
        - Statement:
          - Effect: Allow
            Action:
              - states:StartExecution
            Resource:
              - !Ref BulkLoadMonitorSFN

  CheckBulkLoadStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-CheckBulkLoadStatusFunction
      CodeUri: functions
      Handler: check_bulk_load_status.lambda_handler
      MemorySize: 256
      Timeout: 60
      Environment:
        Variables:
          NeptuneEndpoint: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}
          Region: !Sub ${AWS::Region}
      VpcConfig:
        SecurityGroupIds:
          - !Ref PheBeeLambdaSecurityGroup
        SubnetIds:
          - !Ref SubnetId1
          - !Ref SubnetId2
      Policies:
        - !Ref PheBeeNeptuneReadPolicy
        - !Ref PheBeeNeptuneLoadPolicy

  FireBulkEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${AppName}-FireBulkEventFunction
      CodeUri: functions
      Handler: fire_bulk_event.lambda_handler
      MemorySize: 256
      Timeout: 60
      Environment:
        Variables:
          PheBeeBus: !Ref PheBeeBus
      Policies:
        - !Ref PheBeePutEventsPolicy

  #################
  # Step Functions
  #################

  InstallRDFXMLSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/install_rdfxml.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        StartLoadFunctionArn: !Ref StartLoadFunction
        GetLoadStatusFunctionArn: !Ref GetLoadStatusFunction
        Region: !Sub ${AWS::Region}
        LoaderRole: !GetAtt NeptuneLoaderRole.Arn
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt StartLoadFunction.Arn
              - !GetAtt GetLoadStatusFunction.Arn

  UpdateHPOSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/update_hpo.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        InstallRDFXMLSFNArn: !Ref InstallRDFXMLSFN
        DownloadGithubReleaseFunctionArn: !Ref DownloadGithubReleaseFunction
        UpdateInstallTimestampFunctionArn: !Ref UpdateInstallTimestampFunction
        PheBeeBus: !Ref PheBeeBus
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt DownloadGithubReleaseFunction.Arn
              - !GetAtt UpdateInstallTimestampFunction.Arn
          - Effect: Allow
            Action: states:StartExecution
            Resource:
              - !GetAtt InstallRDFXMLSFN.Arn

  UpdateMondoSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/update_mondo.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        InstallRDFXMLSFNArn: !Ref InstallRDFXMLSFN
        DownloadGithubReleaseFunctionArn: !Ref DownloadGithubReleaseFunction
        UpdateInstallTimestampFunctionArn: !Ref UpdateInstallTimestampFunction
        PheBeeBus: !Ref PheBeeBus
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt DownloadGithubReleaseFunction.Arn
              - !GetAtt UpdateInstallTimestampFunction.Arn
          - Effect: Allow
            Action: states:StartExecution
            Resource:
              - !GetAtt InstallRDFXMLSFN.Arn

  UpdateECOSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/update_eco.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        InstallRDFXMLSFNArn: !Ref InstallRDFXMLSFN
        DownloadGithubReleaseFunctionArn: !Ref DownloadGithubReleaseFunction
        UpdateInstallTimestampFunctionArn: !Ref UpdateInstallTimestampFunction
        PheBeeBus: !Ref PheBeeBus
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt DownloadGithubReleaseFunction.Arn
              - !GetAtt UpdateInstallTimestampFunction.Arn
          - Effect: Allow
            Action: states:StartExecution
            Resource:
              - !GetAtt InstallRDFXMLSFN.Arn


  ImportPhenopacketsSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub ImportPhenopacketsSFN-${AppName}
      DefinitionUri: statemachine/import_phenopackets.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        ParsePhenopacketCollectionFunctionArn: !Ref ParsePhenopacketCollectionFunction
        ProcessPhenopacketFunctionArn: !Ref ProcessPhenopacketFunction
        CreateSubjectFunctionArn: !Ref CreateSubjectFunction
        CreateTermLinkFunctionArn: !Ref CreateTermLinkFunction
        PrepareSubjectTermLinksPayloadFunctionArn: !Ref PrepareSubjectTermLinksPayloadFunction
      Type: STANDARD
      Policies:
        - !Ref PheBeeStepFunctionPolicy
        - !Ref PheBeeS3ReadPolicy
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt CreateSubjectFunction.Arn
              - !GetAtt CreateTermLinkFunction.Arn
              - !GetAtt ParsePhenopacketCollectionFunction.Arn
              - !GetAtt ProcessPhenopacketFunction.Arn
              - !GetAtt PrepareSubjectTermLinksPayloadFunction.Arn
          - Effect: Allow
            Action:
              - states:StartExecution
            Resource:
              - !Sub arn:${AWS::Partition}:states:${AWS::Region}:${AWS::AccountId}:stateMachine:ImportPhenopacketsSFN-${AppName}


  #################
  # DynamoDB
  #################

  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  #################
  # S3 Storage
  #################

  PheBeeBucket:
    Type: AWS::S3::Bucket
    Condition: ShouldCreateS3Bucket
    Properties:
      LoggingConfiguration: 
        !If 
          - ShouldEnableS3Logging
          - DestinationBucketName: !Ref S3AccessLogBucketName
            LogFilePrefix: !Ref S3AccessLogPrefix
          - !Ref AWS::NoValue
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm:  AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      ObjectLockEnabled: false

  PheBeeBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: ShouldCreateS3Bucket
    Properties:
      Bucket: !Ref PheBeeBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowSSLRequestsOnly # AWS Foundational Security Best Practices v1.0.0 S3.5
            Action: "s3:*"
            Principal: "*"
            Effect: "Deny"
            Condition:
              Bool:
                "aws:SecureTransport": "false"
            Resource:
              - !Sub "arn:${AWS::Partition}:s3:::${PheBeeBucket}"
              - !Sub "arn:${AWS::Partition}:s3:::${PheBeeBucket}/*"

  #################
  # HTTP API
  #################

  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      DefinitionBody:
        'Fn::Transform':
          Name: 'AWS::Include'
          Parameters:
            Location: 'api.yaml'

  BulkLoadMonitorSFN:
    Type: AWS::Serverless::StateMachine
    Properties:
      DefinitionUri: statemachine/bulk_load_monitor.asl.json
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt SAMLogs.Arn
        IncludeExecutionData: true
        Level: ALL
      DefinitionSubstitutions:
        CheckBulkLoadStatusFunctionArn: !GetAtt CheckBulkLoadStatusFunction.Arn
        FireBulkEventFunctionArn: !GetAtt FireBulkEventFunction.Arn
      Type: STANDARD
      Policies:
        - Statement:
          - Effect: Allow
            Action:
              - lambda:InvokeFunction
            Resource:
              - !GetAtt CheckBulkLoadStatusFunction.Arn
              - !GetAtt FireBulkEventFunction.Arn
          - Effect: Allow
            Action:
              - logs:CreateLogDelivery
              - logs:GetLogDelivery
              - logs:UpdateLogDelivery
              - logs:DeleteLogDelivery
              - logs:ListLogDeliveries
              - logs:PutResourcePolicy
              - logs:DescribeResourcePolicies
              - logs:DescribeLogGroups
            Resource: "*"

  #################
  # EventBridge
  #################

  PheBeeBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub phebee-bus-${AppName}

  ####################
  # Scheduled Updates
  ####################

  UpdateHPOScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableScheduledOntologyUpdate
    Properties:
      Name: !Sub UpdateHPO-OnSchedule-${AppName}
      ScheduleExpression: !Ref HPOScheduleExpression
      State: ENABLED
      Targets:
        - Arn: !GetAtt UpdateHPOSFN.Arn
          Id: "UpdateHPO"
          RoleArn: !GetAtt UpdateOntologyInvokeRole.Arn
  
  UpdateMondoScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableScheduledOntologyUpdate
    Properties:
      Name: !Sub UpdateMondo-OnSchedule-${AppName}
      ScheduleExpression: !Ref MondoScheduleExpression
      State: ENABLED
      Targets:
        - Arn: !GetAtt UpdateMondoSFN.Arn
          Id: "UpdateMondo"
          RoleArn: !GetAtt UpdateOntologyInvokeRole.Arn

  UpdateECOScheduleRule:
    Type: AWS::Events::Rule
    Condition: EnableScheduledOntologyUpdate
    Properties:
      Name: !Sub UpdateECO-OnSchedule-${AppName}
      ScheduleExpression: !Ref ECOScheduleExpression
      State: ENABLED
      Targets:
        - Arn: !GetAtt UpdateECOSFN.Arn
          Id: "UpdateECO"
          RoleArn: !GetAtt UpdateOntologyInvokeRole.Arn

Outputs:
  UpdateHPOSFNArn:
    Value: !Ref UpdateHPOSFN

  UpdateMondoSFNArn:
    Value: !Ref UpdateMondoSFN

  UpdateECOSFNArn:
    Value: !Ref UpdateECOSFN

  CreateProjectFunctionArn:
    Value: !Ref CreateProjectFunction

  ResetDatabaseFunctionArn:
    Value: !Ref ResetDatabaseFunction

  PrepareBulkUploadFunctionArn:
    Value: !GetAtt PrepareBulkUploadFunction.Arn
    Export:
      Name: !Sub "${AppName}-PrepareBulkUploadFunctionArn"

  PerformBulkUploadFunctionArn:
    Value: !GetAtt PerformBulkUploadFunction.Arn
    Export:
      Name: !Sub "${AppName}-PerformBulkUploadFunctionArn"

  FinalizeBulkUploadFunctionArn:
    Value: !GetAtt FinalizeBulkUploadFunction.Arn
    Export:
      Name: !Sub "${AppName}-FinalizeBulkUploadFunctionArn"

  CheckBulkLoadStatusFunctionArn:
    Value: !GetAtt CheckBulkLoadStatusFunction.Arn
    Export:
      Name: !Sub "${AppName}-CheckBulkLoadStatusFunctionArn"

  FireBulkEventFunctionArn:
    Value: !GetAtt FireBulkEventFunction.Arn
    Export:
      Name: !Sub "${AppName}-FireBulkEventFunctionArn"

  BulkLoadMonitorSFNArn:
    Value: !Ref BulkLoadMonitorSFN
    Export:
      Name: !Sub "${AppName}-BulkLoadMonitorSFNArn"

  GetLoadStatusFunctionArn:
    Value: !GetAtt GetLoadStatusFunction.Arn
    Export:
      Name: !Sub "${AppName}-GetLoadStatusFunctionArn"

  QueryProvenanceFunctionArn:
    Value: !GetAtt QueryProvenanceFunction.Arn
    Export:
      Name: !Sub "${AppName}-QueryProvenanceFunctionArn"

  DynamoDBTableName:
    Description: Table name of the PheBee DynamoDB table
    Value: !Ref DynamoDBTable
    Export:
      Name: !Sub ${AppName}-DynamoDBTableName

  Region:
    Value: !Sub ${AWS::Region}

  NeptuneEndpoint:
    Value: !Sub https://${PheBeeNeptuneCluster.Endpoint}:${PheBeeNeptuneCluster.Port}

  NeptuneClusterIdentifier:
    Value: !Ref PheBeeNeptuneCluster
  
  HttpApiUrl:
    Description: Base URL for the HTTP API
    Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com"

  AppName:
    Description: Application name used for resource naming
    Value: !Ref AppName

  PheBeeBus:
    Description: Name of the custom EventBridge bus for PheBee events
    Value: !Ref PheBeeBus
    Export:
      Name: !Sub "${AppName}-PheBeeBus"