openapi: "3.0.1"
info:
  title:
    Fn::Sub: "phebee-${AWS::AccountId}-${AWS::Region}-${AppName}"
  version: "2020-11-06 15:32:29UTC"

paths:
  # --- Project-related endpoints ---
  /project/create:
    post:
      summary: Create a new project node
      description: |
        Creates a new project node in the PheBee graph if it does not already exist.
        Requires a JSON payload with `project_id` and `project_label`. If the project
        already exists, the request returns a message indicating no changes were made.
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project_id
                - project_label
              properties:
                project_id:
                  type: string
                project_label:
                  type: string
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-CreateProjectFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /project/remove:
    post:
      summary: Remove all data for a project
      description: |
        Deletes all RDF triples associated with the specified project by clearing its named graph
        in the Neptune database.
      operationId: removeProjectData
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project_id
              properties:
                project_id:
                  type: string
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-RemoveProjectFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  # --- Subject-related endpoints ---
  /subject/create:
    post:
      summary: Create or link a subject
      description: |
        Creates a new subject in PheBee or links an existing one to a specified project.
        If a subject with the given identifiers already exists, it is linked to the new project;
        otherwise, a new subject is created and recorded.
      operationId: createOrLinkSubject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project_id
                - project_subject_iri
              properties:
                project_id:
                  type: string
                project_subject_id:
                  type: string
                known_project_id:
                  type: string
                known_project_subject_iri:
                  type: string
                known_subject_iri:
                  type: string
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-CreateSubjectFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /subject:
    post:
      summary: Retrieve subject details and associated terms
      description: |
        Returns metadata and linked terms for a subject, including evidence supporting each association.
        Requires a project ID and a project-specific subject ID to identify the subject in the graph.
      operationId: getSubjectDetails
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project_subject_iri
              properties:
                project_subject_iri:
                  type: string
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-GetSubjectFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /subject/term-info:
    post:
      summary: Retrieve detailed term link information for a specific term on a subject
      description: |
        Returns detailed information about a specific term associated with a subject, including all term links
        and their evidence details. This endpoint provides the detailed view that complements the summary
        information returned by the /subject endpoint.
      operationId: getSubjectTermInfo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subject_iri
                - term_iri
              properties:
                subject_iri:
                  type: string
                term_iri:
                  type: string
                qualifiers:
                  type: array
                  items:
                    type: string
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-GetSubjectTermInfoFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /subject/remove:
    post:
      summary: Remove a subject from the graph
      description: |
        Deletes all RDF triples involving the specified subject, either as the subject or object,
        effectively removing it from the graph.
      operationId: removeSubject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project_subject_iri
              properties:
                project_subject_iri:
                  type: string
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-RemoveSubjectFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /subjects/query:
    post:
      summary: List subjects and their phenotypes for a project
      description: |
        Returns a list of subjects associated with a project. Optionally filters subjects by a given term
        and includes their linked phenotypic terms. Supports cursor-based pagination for large datasets.
      operationId: getSubjectsWithPhenotypes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project_id
              properties:
                project_id:
                  type: string
                term_source:
                  type: string
                term_source_version:
                  type: string
                term_iri:
                  type: string
                include_qualified:
                  type: boolean
                  default: false
                  description: Include term links with negated, hypothetical, or family qualifiers when filtering by term_iri
                include_terms:
                  type: boolean
                include_child_terms:
                  type: boolean
                  default: true
                  description: If true, expand term_iri to include descendant terms (e.g., HPO subclasses) when filtering subjects.
                limit:
                  type: integer
                  minimum: 1
                  maximum: 5000
                  default: 200
                  description: Maximum number of subjects to return per page
                cursor:
                  type: string
                  description: Subject IRI to start pagination after (from previous response's next_cursor)
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-GetSubjectsPhenotypesFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  # --- Term & link-related endpoints ---
  
  /source/{source_name}:
    get:
      summary: Get term source metadata
      description: |
        Retrieves metadata about a specific term source registered in PheBee.
        The response includes details such as version, creation date, graph name, and downloaded file locations.
      operationId: getSourceMetadata
      parameters:
        - name: source_name
          in: path
          required: true
          schema:
            type: string
          description: The name of the data source to retrieve information about.
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-GetSourceInfoFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000










  /evidence/create:
    post:
      summary: Create evidence record
      description: |
        Creates an evidence record linking a subject to a term with supporting metadata.
        Evidence can include clinical note context, text annotations, and qualifiers.
      operationId: createEvidence
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subject_id
                - term_iri
                - creator_id
              properties:
                subject_id:
                  type: string
                  description: The subject UUID
                term_iri:
                  type: string
                  description: The ontology term IRI
                creator_id:
                  type: string
                  description: Unique creator identifier (username, email, tool:version)
                creator_name:
                  type: string
                  description: Display name for creator (optional, defaults to creator_id)
                creator_type:
                  type: string
                  enum: [human, automated]
                  default: human
                  description: Type of creator
                evidence_type:
                  type: string
                  default: "manual_annotation"
                  description: Type of evidence (manual_annotation, clinical_note, etc.)
                encounter_id:
                  type: string
                  description: Optional encounter identifier
                clinical_note_id:
                  type: string
                  description: Optional clinical note identifier
                span_start:
                  type: integer
                  description: Text span start position
                span_end:
                  type: integer
                  description: Text span end position
                note_timestamp:
                  type: string
                  format: date-time
                  description: Clinical note timestamp
                provider_type:
                  type: string
                  description: Healthcare provider type
                author_specialty:
                  type: string
                  description: Author medical specialty
                note_type:
                  type: string
                  description: Type of clinical note
                qualifiers:
                  type: array
                  items:
                    type: string
                  description: Evidence qualifiers (e.g., negated)
      responses:
        "201":
          description: Evidence created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  evidence_id:
                    type: string
        "400":
          description: Missing required fields
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-CreateEvidenceFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /evidence:
    post:
      summary: Get evidence record
      description: |
        Retrieves an evidence record by its ID with all associated metadata.
      operationId: getEvidence
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - evidence_id
              properties:
                evidence_id:
                  type: string
                  description: The evidence record ID
      responses:
        "200":
          description: Evidence retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  evidence_id:
                    type: string
                  subject_id:
                    type: string
                  term_iri:
                    type: string
                  evidence_type:
                    type: string
                  creator:
                    type: object
                  text_annotation:
                    type: object
                  note_context:
                    type: object
                  qualifiers:
                    type: array
        "404":
          description: Evidence not found
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-GetEvidenceFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /evidence/remove:
    post:
      summary: Remove evidence record
      description: |
        Deletes an evidence record by its ID.
      operationId: removeEvidence
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - evidence_id
              properties:
                evidence_id:
                  type: string
                  description: The evidence record ID
      responses:
        "200":
          description: Evidence removed successfully
        "404":
          description: Evidence not found
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-RemoveEvidenceFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /term-link/create:
    post:
      summary: Create a TermLink node
      description: |
        Creates a TermLink node that connects a Subject, Encounter, or ClinicalNote to a term with supporting evidence.
      operationId: createTermLink
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subject_id
                - term_iri
                - creator_id
              properties:
                subject_id:
                  type: string
                  description: The subject UUID
                term_iri:
                  type: string
                  description: The ontology term IRI
                creator_id:
                  type: string
                  description: The creator identifier
                qualifiers:
                  type: array
                  items:
                    type: string
                  description: Optional qualifier IRIs
      responses:
        "200":
          description: TermLink created
        "400":
          description: Missing required fields or invalid structure
        "500":
          description: Internal server error
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-CreateTermLinkFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /term-link:
    post:
      summary: Get TermLink details
      description: |
        Retrieves a TermLink node and its associated properties.
      operationId: getTermLink
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - termlink_iri
              properties:
                termlink_iri:
                  type: string
      responses:
        "200":
          description: TermLink found or not found
        "400":
          description: Missing required field
        "500":
          description: Internal server error
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-GetTermLinkFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  /term-link/remove:
    post:
      summary: Delete a TermLink node
      description: |
        Deletes a TermLink node by IRI.
      operationId: removeTermLink
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - termlink_iri
              properties:
                termlink_iri:
                  type: string
      responses:
        "200":
          description: TermLink deleted
        "400":
          description: Missing required field
        "500":
          description: Internal server error
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-RemoveTermLinkFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

  # --- Provenance-related endpoints ---
  /provenance/query:
    post:
      summary: Query provenance information
      description: |
        Query provenance data including activities, entities, agents, and lineage information.
        Supports various query types for comprehensive audit and tracking capabilities.
      operationId: queryProvenance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                query_type:
                  type: string
                  enum: ["activity", "entity", "agent", "lineage", "sparql"]
                  description: Type of provenance query to execute
                run_id:
                  type: string
                  description: Specific run ID to query (optional)
                batch_id:
                  type: string
                  description: Specific batch ID to query (optional)
                entity_iri:
                  type: string
                  description: Entity IRI for lineage queries (optional)
                sparql_query:
                  type: string
                  description: Custom SPARQL query (required for sparql query_type)
                limit:
                  type: integer
                  minimum: 1
                  maximum: 1000
                  default: 100
                  description: Maximum number of results to return
              required:
                - query_type
              examples:
                activity_query:
                  summary: Query activities for a specific run
                  value:
                    query_type: "activity"
                    run_id: 1
                    limit: 50
                entity_query:
                  summary: Query entities
                  value:
                    query_type: "entity"
                    limit: 100
                lineage_query:
                  summary: Query entity lineage
                  value:
                    query_type: "lineage"
                    entity_iri: "http://ods.nationwidechildrens.org/phebee/subjects/12345"
                sparql_query:
                  summary: Custom SPARQL query
                  value:
                    query_type: "sparql"
                    sparql_query: "SELECT ?s ?p ?o WHERE { ?s ?p ?o } LIMIT 10"
      responses:
        "200":
          description: Provenance query results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    description: Query results
                  count:
                    type: integer
                    description: Number of results returned
                  query_type:
                    type: string
                    description: Type of query executed
        "400":
          description: Invalid query parameters
        "500":
          description: Internal server error
      security:
        - sigv4: []
      x-amazon-apigateway-integration:
        credentials:
          Fn::GetAtt: [PheBeeAPIRole, Arn]
        payloadFormatVersion: "2.0"
        type: "aws_proxy"
        uri:
          Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AppName}-QueryProvenanceFunction/invocations
        connectionType: "INTERNET"
        timeoutInMillis: 30000

x-amazon-apigateway-cors:
  allowMethods:
    - "*"
  maxAge: 0
  allowCredentials: false
  allowOrigins:
    - "*"
  allowHeaders:
    - "*"
x-amazon-apigateway-importexport-version: "1.0"
