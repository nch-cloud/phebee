{
  "Comment": "Bulk Evidence Import Pipeline with EMR Serverless, DynamoDB, Lambda preprocessing, and proper permissions",
  "StartAt": "ValidateInput",
  "States": {
    "ValidateInput": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${ValidateBulkImportFunction}",
        "Payload": {
          "run_id.$": "$.run_id",
          "input_path.$": "$.input_path"
        }
      },
      "ResultPath": "$.validation",
      "Next": "CheckValidation",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "NotifyFailure",
        "ResultPath": "$.error"
      }]
    },
    
    "CheckValidation": {
      "Type": "Choice",
      "Choices": [{
        "Variable": "$.validation.Payload.body.validated",
        "BooleanEquals": true,
        "Next": "ResolveSubjectMappings"
      }],
      "Default": "NotifyFailure"
    },
    
    "ResolveSubjectMappings": {
      "Type": "Task",
      "Resource": "arn:aws:states:::emr-serverless:startJobRun.sync",
      "Parameters": {
        "ApplicationId": "${EMRServerlessApplicationId}",
        "ExecutionRoleArn": "${EMRExecutionRoleArn}",
        "Name.$": "States.Format('ResolveSubjectMappings-{}', $.run_id)",
        "JobDriver": {
          "SparkSubmit": {
            "EntryPoint": "s3://${PheBeeBucketName}/scripts/resolve_subject_mappings_emr.py",
            "EntryPointArguments.$": "States.Array('--run-id', $.run_id, '--input-path', $.input_path, '--mapping-file', States.Format('s3://${PheBeeBucketName}/runs/{}/subject_mapping.json', $.run_id), '--dynamodb-table', '${DynamoDBTableName}', '--region', '${AWSRegion}')"
          }
        },
        "ConfigurationOverrides": {
          "MonitoringConfiguration": {
            "S3MonitoringConfiguration": {
              "LogUri": "s3://${PheBeeBucketName}/emr-logs/"
            }
          }
        }
      },
      "ResultPath": "$.subject_mapping",
      "Next": "ProcessWithEMR",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "NotifyFailure",
          "ResultPath": "$.error"
        }
      ]
    },
    
    "ProcessWithEMR": {
      "Type": "Task",
      "Resource": "arn:aws:states:::emr-serverless:startJobRun.sync",
      "Parameters": {
        "ApplicationId": "${EMRServerlessApplicationId}",
        "ExecutionRoleArn": "${EMRExecutionRoleArn}",
        "JobDriver": {
          "SparkSubmit": {
            "EntryPoint": "s3://${PheBeeBucketName}/scripts/bulk_evidence_processor.py",
            "EntryPointArguments.$": "States.Array('--run-id', $.run_id, '--input-path', $.input_path, '--mapping-file', States.Format('s3://${PheBeeBucketName}/runs/{}/subject_mapping.json', $.run_id), '--iceberg-database', '${IcebergDatabase}', '--iceberg-table', '${IcebergEvidenceTable}', '--output-bucket', '${PheBeeBucketName}', '--neptune-cluster', '${NeptuneClusterEndpoint}')",
            "SparkSubmitParameters": "--conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions --conf spark.sql.catalog.glue_catalog=org.apache.iceberg.spark.SparkCatalog --conf spark.sql.catalog.glue_catalog.warehouse=s3://${PheBeeBucketName}/iceberg-warehouse --conf spark.sql.catalog.glue_catalog.catalog-impl=org.apache.iceberg.aws.glue.GlueCatalog --conf spark.sql.catalog.glue_catalog.io-impl=org.apache.iceberg.aws.s3.S3FileIO"
          }
        },
        "ConfigurationOverrides": {
          "MonitoringConfiguration": {
            "S3MonitoringConfiguration": {
              "LogUri": "s3://${PheBeeBucketName}/emr-logs/"
            }
          }
        }
      },
      "ResultPath": "$.emr_result",
      "Next": "GenerateTTLWithEMR",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "NotifyFailure",
        "ResultPath": "$.error"
      }]
    },
    
    "GenerateTTLWithEMR": {
      "Type": "Task",
      "Resource": "arn:aws:states:::emr-serverless:startJobRun.sync",
      "Parameters": {
        "ApplicationId": "${EMRServerlessApplicationId}",
        "ExecutionRoleArn": "${EMRExecutionRoleArn}",
        "JobDriver": {
          "SparkSubmit": {
            "EntryPoint": "s3://${PheBeeBucketName}/scripts/generate_ttl_from_iceberg_emr.py",
            "EntryPointArguments.$": "States.Array($.run_id, '${IcebergDatabase}', '${IcebergEvidenceTable}', '${PheBeeBucketName}', States.Format('s3://${PheBeeBucketName}/runs/{}/subject_mapping.json', $.run_id), '${AWSRegion}')",
            "SparkSubmitParameters": "--conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions --conf spark.sql.catalog.glue_catalog=org.apache.iceberg.spark.SparkCatalog --conf spark.sql.catalog.glue_catalog.warehouse=s3://${PheBeeBucketName}/iceberg-warehouse --conf spark.sql.catalog.glue_catalog.catalog-impl=org.apache.iceberg.aws.glue.GlueCatalog --conf spark.sql.catalog.glue_catalog.io-impl=org.apache.iceberg.aws.s3.S3FileIO"
          }
        },
        "ConfigurationOverrides": {
          "MonitoringConfiguration": {
            "S3MonitoringConfiguration": {
              "LogUri": "s3://${PheBeeBucketName}/emr-logs/"
            }
          }
        },
        "Name.$": "States.Format('GenerateTTL-{}', $.run_id)"
      },
      "ResultPath": "$.ttl_generation",
      "Next": "StartProjectLoad",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "NotifyFailure",
        "ResultPath": "$.error"
      }]
    },
    
    "StartProjectLoad": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${StartNeptuneBulkLoadFunction}",
        "Payload": {
          "run_id.$": "$.run_id",
          "ttl_prefix.$": "States.Format('s3://${PheBeeBucketName}/runs/{}/neptune/', $.run_id)",
          "load_type": "projects"
        }
      },
      "ResultPath": "$.project_load",
      "Next": "CheckProjectLoadsExist",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "NotifyFailure",
        "ResultPath": "$.error"
      }]
    },
    
    "CheckProjectLoadsExist": {
      "Type": "Choice",
      "Choices": [{
        "Variable": "$.project_load.Payload.body.total_loads",
        "NumericGreaterThan": 0,
        "Next": "MonitorProjectLoad"
      }],
      "Default": "StartSubjectsLoad"
    },
    
    "MonitorProjectLoad": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${CheckNeptuneBulkLoadStatusFunction}",
        "Payload": {
          "load_id.$": "$.project_load.Payload.body.loads[0].load_id"
        }
      },
      "ResultPath": "$.project_status",
      "Next": "CheckProjectLoadComplete"
    },
    
    "CheckProjectLoadComplete": {
      "Type": "Choice",
      "Choices": [{
        "Variable": "$.project_status.Payload.body.status",
        "StringEquals": "LOAD_COMPLETED",
        "Next": "StartSubjectsLoad"
      }, {
        "Variable": "$.project_status.Payload.body.status",
        "StringEquals": "LOAD_FAILED",
        "Next": "NotifyFailure"
      }],
      "Default": "WaitForProjectLoad"
    },
    
    "WaitForProjectLoad": {
      "Type": "Wait",
      "Seconds": 30,
      "Next": "MonitorProjectLoad"
    },
    
    "StartSubjectsLoad": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${StartNeptuneBulkLoadFunction}",
        "Payload": {
          "run_id.$": "$.run_id",
          "ttl_prefix.$": "States.Format('s3://${PheBeeBucketName}/runs/{}/neptune/', $.run_id)",
          "load_type": "subjects"
        }
      },
      "ResultPath": "$.subjects_load",
      "Next": "CheckSubjectLoadsExist",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "NotifyFailure",
        "ResultPath": "$.error"
      }]
    },
    
    "CheckSubjectLoadsExist": {
      "Type": "Choice",
      "Choices": [{
        "Variable": "$.subjects_load.Payload.body.total_loads",
        "NumericGreaterThan": 0,
        "Next": "MonitorSubjectsLoad"
      }],
      "Default": "NotifySuccess"
    },
    
    "MonitorSubjectsLoad": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${CheckNeptuneBulkLoadStatusFunction}",
        "Payload": {
          "load_id.$": "$.subjects_load.Payload.body.loads[0].load_id"
        }
      },
      "ResultPath": "$.subjects_status",
      "Next": "CheckSubjectsLoadComplete"
    },
    
    "CheckSubjectsLoadComplete": {
      "Type": "Choice",
      "Choices": [{
        "Variable": "$.subjects_status.Payload.body.status",
        "StringEquals": "LOAD_COMPLETED",
        "Next": "MaterializeProjectSubjectTerms"
      }, {
        "Variable": "$.subjects_status.Payload.body.status",
        "StringEquals": "LOAD_FAILED",
        "Next": "NotifyFailure"
      }],
      "Default": "WaitForSubjectsLoad"
    },
    
    "WaitForSubjectsLoad": {
      "Type": "Wait",
      "Seconds": 30,
      "Next": "MonitorSubjectsLoad"
    },

    "MaterializeProjectSubjectTerms": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${MaterializeProjectSubjectTermsFunction}",
        "Payload": {
          "project_id.$": "$.validation.Payload.body.project_id",
          "run_id.$": "$.run_id",
          "batch_size": 100
        }
      },
      "ResultPath": "$.materialization",
      "Next": "CheckMaterializationStatus",
      "Catch": [{
        "ErrorEquals": ["States.ALL"],
        "Next": "NotifyFailure",
        "ResultPath": "$.error"
      }]
    },

    "CheckMaterializationStatus": {
      "Type": "Choice",
      "Choices": [{
        "Variable": "$.materialization.Payload.status",
        "StringEquals": "success",
        "Next": "NotifySuccess"
      }],
      "Default": "NotifySuccess",
      "Comment": "Always proceed to success - materialization is optional optimization"
    },

    "NotifySuccess": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${NotifyBulkImportCompleteFunction}",
        "Payload": {
          "run_id.$": "$.run_id",
          "status": "SUCCESS",
          "emr_job_id.$": "$.emr_result.JobRunId",
          "project_loads.$": "$.project_load.Payload.body.total_loads",
          "subject_loads.$": "$.subjects_load.Payload.body.total_loads"
        }
      },
      "End": true
    },
    
    "NotifyFailure": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke", 
      "Parameters": {
        "FunctionName": "${NotifyBulkImportFailureFunction}",
        "Payload": {
          "run_id.$": "$.run_id",
          "status": "FAILED",
          "error.$": "$.error"
        }
      },
      "Next": "FailExecution"
    },
    
    "FailExecution": {
      "Type": "Fail",
      "Cause": "Bulk import failed",
      "Error": "BulkImportError"
    }
  }
}
